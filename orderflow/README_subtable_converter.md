# kintone サブテーブル→CSV変換スクリプト

## 概要
kintoneのサブテーブルの各フィールドをカンマ区切りで別のフィールドに出力するJavaScriptです。
サブテーブルのデータを扱いやすいCSV形式に変換し、テキストフィールドに出力します。

## 機能
- ✅ サブテーブルの複数フィールドをCSV形式に変換
- ✅ 手動変換ボタンの提供
- ✅ レコード保存時の自動変換
- ✅ 各種フィールドタイプに対応
- ✅ CSVエスケープ処理
- ✅ ヘッダー行の追加/除去設定
- ✅ JSON形式出力オプション

## セットアップ手順

### 1. フィールド設定の確認
スクリプト内の `CONFIG` セクションを実際のアプリに合わせて設定：

```javascript
const CONFIG = {
    // サブテーブルのフィールドコード
    subtableFieldCode: 'サブテーブル',
    
    // 出力先のフィールドコード（文字列（複数行）推奨）
    outputFieldCode: '出力結果',
    
    // サブテーブル内の対象フィールド
    targetFields: [
        '項目1',  // 実際のフィールドコードに変更
        '項目2',
        '項目3'
    ],
    
    // 出力形式設定
    separator: ', ',        // フィールド間区切り文字
    rowSeparator: '\n',     // 行間区切り文字
    includeHeader: true,    // ヘッダー行を含むか
    headerNames: ['項目1', '項目2', '項目3'] // ヘッダー名
};
```

### 2. kintoneアプリに適用
1. kintoneアプリの設定 > JavaScript / CSS でカスタマイズ
2. `kintone_subtable_converter.js` をアップロード
3. アプリを更新

## 使用方法

### 🔄 自動変換
- レコード保存時に自動的にサブテーブルがCSV形式に変換されます
- 新規作成・編集どちらでも動作します

### 🔘 手動変換
1. レコード詳細画面または編集画面を開く
2. ヘッダー部分の「サブテーブルをCSVに変換」ボタンをクリック
3. 即座に変換結果が出力フィールドに反映されます

## 出力例

### サブテーブルデータ
| 商品名 | 数量 | 単価 |
|--------|------|------|
| りんご | 10   | 100  |
| みかん | 5    | 80   |
| バナナ | 8    | 120  |

### CSV出力（ヘッダーあり）
```
商品名, 数量, 単価
りんご, 10, 100
みかん, 5, 80
バナナ, 8, 120
```

### CSV出力（ヘッダーなし）
```
りんご, 10, 100
みかん, 5, 80
バナナ, 8, 120
```

## 対応フィールドタイプ

### ✅ 基本フィールド
- **文字列（1行）**: そのまま出力
- **文字列（複数行）**: そのまま出力（改行はエスケープ）
- **数値**: 数値として出力
- **日時**: 日時文字列として出力

### ✅ 選択系フィールド
- **ドロップダウン**: 選択値を出力
- **ラジオボタン**: 選択値を出力
- **チェックボックス**: 複数選択値をセミコロン区切りで出力
- **複数選択**: 複数選択値をセミコロン区切りで出力

### ✅ 関連レコードフィールド
- **ユーザー選択**: ユーザー名をセミコロン区切りで出力
- **組織選択**: 組織名をセミコロン区切りで出力

### ✅ その他フィールド
- **ファイル**: ファイル名をセミコロン区切りで出力
- **リンク**: URL文字列として出力

## カスタマイズオプション

### 1. 区切り文字の変更
```javascript
separator: '\t',        // タブ区切り
rowSeparator: '\r\n',   // Windows改行
```

### 2. 特定列のみ抽出
```javascript
// 1つのフィールドのみをカンマ区切りで抽出
const result = window.kintoneSubtableConverter.extractColumn(record, '商品名');
// 結果: "りんご, みかん, バナナ"
```

### 3. JSON形式での出力
```javascript
// JSON形式で出力
const jsonResult = window.kintoneSubtableConverter.convertToJSON(record);
```

### 4. 条件付き変換
```javascript
// 特定条件の行のみ変換
function convertWithCondition(record) {
    const subtableData = record['サブテーブル'];
    const filteredData = subtableData.value.filter(function(row) {
        return row.value['数量'].value > 5; // 数量が5より大きい行のみ
    });
    
    // フィルタ後のデータで変換処理...
}
```

## トラブルシューティング

### よくある問題

1. **フィールドコードが見つからない**
   - kintone設定画面でフィールドコードを確認
   - 大文字小文字を正確に入力

2. **出力フィールドに反映されない**
   - 出力先フィールドが「文字列（複数行）」タイプか確認
   - フィールドコードが正しいか確認

3. **特殊文字が正しく表示されない**
   - CSVエスケープ処理により自動的に処理されます
   - カンマや改行を含む値は自動的にクォートされます

### デバッグ方法
ブラウザの開発者ツール（F12）のコンソールで確認：

```javascript
// 現在のレコードを取得
const record = kintone.app.record.get().record;

// 変換テスト
const csvResult = window.kintoneSubtableConverter.convertToCSV(record);
console.log(csvResult);
```

## 応用例

### 1. レポート用データ出力
サブテーブルの売上データを分析ツール用にCSV形式で出力

### 2. 一括データ処理
複数のサブテーブル行を1つのテキストフィールドにまとめて保存

### 3. 外部システム連携
CSVまたはJSON形式でのデータエクスポート準備

### 4. メール送信用データ整形
メール本文にサブテーブルデータを見やすい形式で挿入

## ライセンス
このスクリプトは自由に使用・改変可能です。